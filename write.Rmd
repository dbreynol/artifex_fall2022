# Time Series

## Decomposition

We want to decompose our time series into three parts: a trend component ($T$), a seasonality component ($S$), and a random component ($R$). That is, for each observation $Y_t$, we want to break it down into three parts:

$Y_T = T_t + S_t + R_t$

First, let's talk about the trend component (T). The trend component is a moving average, which you can obtain using the <code>ma</code> function within the *forecast* library.

```{r echo=TRUE}
set.seed(1)

# generate some fake data that resembles our real dataset (noce the week_no variable, which 
# corresponds with the enterprise week number from your original data)

df = data.frame( invoiced = round(rnorm(52 * 3, mean = 100, sd = 30), 0), 
                 week_no = rep(1:52, 3), # week number
                 id = 1:(52 * 3)) 


y_ts = ts(df$invoiced, frequency = 52) # make your data into a time series object
df$trend = ma(y_ts, order = 52) # use the ma function from the forecast library
```

Now that we have added a trend variable to our data frame, let's get the seasonal ($S$) component. To estimate the seasonal component for each week, simply average the detrended values for that week. These seasonal component values are then adjusted to ensure that they add to zero.

```{r, echo=T}
# 1. subtract the trend
df$detrend = df$invoiced - df$trend

# 2. group by week number and take the average of the de-trended values
df = df %>% group_by(week_no) %>% 
  mutate(S1 = mean(detrend, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(S = S1 - mean(S1)) %>% # make sure the sum of the seasonal components is 0
  select(!c(detrend, S1))
```

Finally, the random component is calculated by subtracting the estimated seasonal and trend-cycle components. That is, 

$R_t = Y_t - T_t - S_t$.

```{r, echo=TRUE}
df = mutate(df, R = invoiced - trend - S)
```

Now, plot each line:

```{r echo=TRUE}
df %>% 
  pivot_longer(!(c("week_no", "id"))) %>% 
  ggplot(aes(id, value, color = name)) + 
  geom_line() + 
  theme_minimal() + 
  ggtitle("Decomposition of invoiced time series")
```

## Forecasting